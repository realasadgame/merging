<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge PDF - Tools India Gup</title>
    <style>
        :root {
            --primary-color: #e53e3e;
            --primary-hover-color: #c53030;
            --background-color: #f7f7fb;
            --card-background: #ffffff;
            --text-color: #333;
            --secondary-text-color: #718096;
            --border-color: #e2e8f0;
            --transition-speed: 0.3s;
            --shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            /* CORRECTED: Changed from min-height to strict height */
            display: flex;
            flex-direction: column;
            line-height: 1.5;
            overflow: hidden;
            /* CORRECTED: Prevent the body itself from ever scrolling */
        }

        /* Loaders & Upload Screen */
        .loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(247, 247, 251, 0.95);
            backdrop-filter: blur(5px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 1rem;
        }

        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        #loading-text {
            margin-top: 20px;
            font-size: 1.5rem;
            color: var(--text-color);
            font-weight: 500;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        #upload-status-text {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        #upload-filename-text {
            color: var(--secondary-text-color);
            margin-bottom: 1.5rem;
        }

        #upload-progress-bar-container {
            width: 100%;
            max-width: 400px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            height: 8px;
            margin-bottom: 1rem;
        }

        #upload-progress-bar {
            width: 0%;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.2s ease-out;
        }

        #upload-percentage {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 0rem;
            color: #000;
        }

        #upload-label {
            color: var(--secondary-text-color);
            letter-spacing: 2px;
            font-size: 0.9rem;
        }

        /* Message Box */
        .message-box {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffebee;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 11000;
            max-width: 90%;
            text-align: center;
            color: #c62828;
            font-weight: 500;
        }

        /* Screens */
        .initial-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* justify-content: center; */
            padding: 2rem;
            padding-bottom: 15vh;
            /* CORRECTED: Pushes content up from the absolute center */
            flex-grow: 1;
            width: 100%;
        }

        .post-merge-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0 auto;
            padding: 2rem;
            flex-grow: 1;
            width: 100%;
            overflow-y: auto;
        }

        .app-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .app-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .app-header p {
            font-size: 1.125rem;
            color: var(--secondary-text-color);
            max-width: 550px;
            margin: 1rem auto 0;
        }

        /* Drop Area */
        .drop-area {
            background: var(--card-background);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 600px;
        }

        .drop-area.drag-over {
            border-color: var(--primary-color);
            background-color: #fff5f5;
        }

        .drop-area p {
            margin-top: 1rem;
            color: var(--secondary-text-color);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color var(--transition-speed);
        }

        .btn-primary:hover {
            background: var(--primary-hover-color);
        }

        /* File Selection Screen */
        .file-selection-screen {
            display: none;
            flex-direction: row;
            flex-grow: 1;
            overflow: hidden;
        }

        .left-panel {
            flex: 3;
            background: #f7f7fb;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
        }

        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 28px 32px;
            padding: 70px 36px 36px 36px;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }

        .right-panel {
            flex: 1;
            background: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-left: 1px solid #e2e8f0;
            min-width: 350px;
            max-width: 350px;
            z-index: 2;
        }

        .right-panel h2 {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .info-box {
            background: #e6f3fc;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 1rem;
        }

        /* PDF Preview Box */
        .file-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
            padding: 10px;
            text-align: center;
            width: 200px;
            display: flex;
            flex-direction: column;
            position: relative;
            cursor: grab;
            border: 1px solid #ececec;
            transition: all 0.2s;
        }

        .file-box:active {
            cursor: grabbing;
        }

        @media (hover: hover) {
            .file-box:hover {
                transform: translateY(-4px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
            }

            .file-box:hover .action-btn {
                opacity: 1;
                pointer-events: auto;
            }
        }

        .file-box canvas {
            width: 100%;
            height: 240px;
            border-radius: 7px;
            background: #f0f0f0;
            margin-bottom: 8px;
            object-fit: contain;
            border: 1px solid #e2e8f0;
        }

        .file-box p {
            font-size: 13px;
            color: #333;
            word-break: break-all;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            height: 36px;
            line-height: 1.4;
        }

        /* Action Buttons on File Box */
        .file-box .action-btn {
            position: absolute;
            top: 6px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
        }

        .file-box .remove-btn {
            right: 6px;
        }

        .file-box .view-btn {
            right: 42px;
        }

        .file-box .rotate-btn {
            right: 78px;
        }

        .file-box .action-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        .file-box .action-btn:hover svg {
            stroke: white;
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
            stroke: #333;
            stroke-width: 2.5;
            transition: stroke 0.2s;
        }

        .sortable-ghost {
            opacity: 0.4;
        }

        .sortable-chosen {
            border: 2px solid var(--primary-color);
        }

        /* Floating Buttons */
        .add-btn,
        .settings-btn {
            position: fixed;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .remove-all-btn {
            position: fixed;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            border: none;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .add-btn {
            top: 60px;
            right: 400px;
            background: var(--primary-color);
            font-size: 28px;
        }

        .settings-btn {
            top: 20px;
            right: 20px;
            background: white;
            color: black;
            font-size: 22px;
        }

        .remove-all-btn {
            top: 20px;
            left: 20px;
            background: #718096;
            font-size: 22px;
        }

        /* Merge Buttons */
        .merge-btn,
        .merge-btn-mobile {
            background: var(--primary-color);
            border: none;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .merge-btn:hover:not(:disabled),
        .merge-btn-mobile:hover:not(:disabled) {
            background: var(--primary-hover-color);
        }

        .merge-btn:disabled,
        .merge-btn-mobile:disabled {
            background: #e2e8f0;
            cursor: not-allowed;
            color: #a0aec0;
        }

        /* Post Merge Screen & Other Tools Section */
        .post-merge-screen .app-header h1 {
            color: #333;
        }

        .result-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 1.5rem;
        }

        .btn-download {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            padding: 12px 24px;
            font-weight: bold;
            border-radius: 8px;
        }

        .back-arrow-btn,
        .side-action-btn {
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-arrow-btn:hover,
        .side-action-btn:hover {
            background: #cbd5e0;
        }

        .continue-to,
        .security-info {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
            width: 100%;
            max-width: 700px;
            text-align: left;
        }

        .continue-to h3,
        .security-info h3 {
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .tool-grid a {
            text-decoration: none;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .tool-grid a:hover {
            background: #f0f0f0;
        }

        .tool-grid a svg {
            flex-shrink: 0;
        }

        .tool-grid a span {
            font-size: 0.9rem;
        }

        .security-info {
            border: 1px solid #bce2ff;
            background: #f0f8ff;
        }

        .security-info p {
            color: var(--secondary-text-color);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            line-height: 1.6;
        }

        .security-info strong {
            color: var(--text-color);
        }

        /* PDF Viewer Modal (NEW) */
        .pdf-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 12000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .pdf-viewer-modal iframe {
            width: 100%;
            height: 100%;
            max-width: 90vw;
            max-height: 95vh;
            background: white;
            border: none;
            border-radius: 8px;
        }

        .pdf-viewer-close {
            position: absolute;
            top: 15px;
            right: 25px;
            background: none;
            border: none;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .add-btn {
                top: 100px;
                right: 15px;
                width: 44px;
                height: 44px;
                background: var(--primary-color);
                font-size: 28px;
            }

            .right-panel {
                position: fixed;
                top: 0;
                right: -100%;
                width: 90vw;
                max-width: 400px;
                height: 100%;
                z-index: 1001;
                box-shadow: -4px 0 24px rgba(0, 0, 0, 0.18);
                transition: right 0.35s cubic-bezier(.4, 0, .2, 1);
            }

            .right-panel.open {
                right: 0;
                display: flex;
            }

            .right-panel .merge-btn {
                display: block;
                position: absolute;
                bottom: 20px;
                left: 20px;
                width: calc(100% - 40px);
            }

            .merge-btn-mobile {
                display: none;
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: calc(100% - 40px);
                z-index: 100;
            }

            .add-btn,
            .remove-all-btn,
            .settings-btn {
                display: flex !important;
            }

            .tool-grid {
                grid-template-columns: 1fr;
            }

            .file-box .action-btn {
                opacity: 1;
                pointer-events: auto;
            }
        }

        @media (min-width: 769px) {
            .settings-btn {
                display: none !important;
            }

            .merge-btn-mobile {
                display: none !important;
            }
        }

        #right-panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #right-panel-overlay.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Loading overlay for general processing -->
    <div id="loading-overlay" class="loader-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">Processing...</p>
    </div>
    <!-- Loading overlay specifically for file "upload" simulation -->
    <div id="upload-progress-overlay" class="loader-overlay">
        <p id="upload-status-text"></p>
        <p id="upload-filename-text" style="font-size: 0.9rem;"></p>
        <div id="upload-progress-bar-container">
            <div id="upload-progress-bar"></div>
        </div>
        <h2 id="upload-percentage">0%</h2>
        <p id="upload-label">UPLOADED</p>
    </div>

    <!-- Initial screen for selecting files -->
    <div id="initial-screen" class="initial-screen">
        <header class="app-header">
            <h1>Merge PDF files</h1>
            <p>Combine PDFs in the order you want with the easiest PDF merger available.</p>
        </header>
        <div id="drop-area" class="drop-area"><button id="select-files-btn" class="btn-primary">Select PDF
                files</button>
            <p>or drop PDFs here</p>
        </div>
    </div>

    <!-- Main screen for arranging and merging files -->
    <div id="file-selection-screen" class="file-selection-screen">
        <div class="left-panel">
            <div id="file-list" class="file-list"></div>
            <button class="add-btn" title="Add more files">+</button>
            <button class="settings-btn" title="Settings">⚙</button>
            <button class="remove-all-btn" title="Remove all files">🗑</button>
        </div>
        <div class="right-panel" id="rightPanel">
            <button id="close-right-panel"
                style="position:absolute;top:10px;left:10px;background:none;border:none;font-size:2rem;display:none;">&times;</button>
            <div>
                <h2>Merge PDF</h2>
                <div class="info-box">To reorder, drag and drop the files. Use the icons on the files to rotate or
                    remove them.</div>
            </div>
            <button id="merge-btn" class="merge-btn" disabled><span>Merge PDF</span></button>
        </div>
    </div>
    <button class="merge-btn merge-btn-mobile" id="mergeBtnMobile" disabled><span>Merge PDF</span></button>

    <!-- Screen shown after the merge is complete -->
    <div id="post-merge-screen" class="post-merge-screen">
        <header class="app-header">
            <h1>PDFs have been merged!</h1>
        </header>
        <div class="result-actions">
            <button class="back-arrow-btn" id="back-arrow" title="Start Over"><svg width="24" height="24"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5" stroke="#333" stroke-width="2" stroke-linecap="round" />
                    <path d="M12 19l-7-7 7-7" stroke="#333" stroke-width="2" stroke-linecap="round" />
                </svg></button>
            <button id="download-btn" class="btn-primary btn-download"><svg width="24" height="24" viewBox="0 0 24 24"
                    fill="none">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="white"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>Download merged PDF</button>
            <div class="side-actions" style="display: flex; gap: 8px;">
                <button class="side-action-btn" id="delete-btn" title="Delete Merged File and Start Over"><svg
                        width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                            stroke="#e53e3e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg></button>
            </div>
        </div>
        <div class="continue-to">
            <h3>Continue to...</h3>
            <div class="tool-grid">
                <a href="#"><span>Compress PDF</span></a> <a href="#"><span>Split PDF</span></a>
                <a href="#"><span>Add watermark</span></a> <a href="#"><span>Rotate PDF</span></a>
            </div>
        </div>
        <div class="security-info">
            <h3>Your Privacy Comes First. Always.</h3>
            <p>We believe your files are your own. This tool operates entirely within your browser. <strong>Nothing is
                    ever uploaded to our servers</strong>, ensuring your documents remain completely private and secure
                on your computer.</p>
            <p><strong>Proof? No Login Required & No Internet Needed After Loading.</strong> Because all processing
                happens on your device, you can disconnect from the internet after this page loads, and the tool will
                still work perfectly. This is your guarantee that your data never leaves your control.</p>
        </div>
    </div>

    <!-- Universal message box for errors and info -->
    <div id="message-box" class="message-box"></div>
    <!-- Overlay for mobile right panel -->
    <div id="right-panel-overlay"></div>

    <!-- Modal for viewing a single PDF -->
    <div id="pdf-viewer-modal" class="pdf-viewer-modal">
        <button id="pdf-viewer-close" class="pdf-viewer-close">&times;</button>
        <iframe id="pdf-viewer-iframe" frameborder="0"></iframe>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <!-- Main Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Set up the worker for PDF.js to render previews
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

            // Cache all necessary DOM elements for quick access
            const elements = {
                initialScreen: document.getElementById('initial-screen'), fileSelectionScreen: document.getElementById('file-selection-screen'),
                postMergeScreen: document.getElementById('post-merge-screen'), dropArea: document.getElementById('drop-area'),
                fileList: document.getElementById('file-list'), selectFilesBtn: document.getElementById('select-files-btn'),
                addBtn: document.querySelector('.add-btn'), settingsBtn: document.querySelector('.settings-btn'),
                removeAllBtn: document.querySelector('.remove-all-btn'), mergeBtn: document.getElementById('merge-btn'),
                mergeBtnMobile: document.getElementById('mergeBtnMobile'), rightPanel: document.getElementById('rightPanel'),
                closeRightPanelBtn: document.getElementById('close-right-panel'), rightPanelOverlay: document.getElementById('right-panel-overlay'),
                downloadBtn: document.getElementById('download-btn'), backArrowBtn: document.getElementById('back-arrow'),
                deleteBtn: document.getElementById('delete-btn'), messageBox: document.getElementById('message-box'),
                loadingOverlay: document.getElementById('loading-overlay'), loadingText: document.getElementById('loading-text'),
                uploadProgressOverlay: document.getElementById('upload-progress-overlay'),
                uploadProgressBar: document.getElementById('upload-progress-bar'),
                uploadPercentage: document.getElementById('upload-percentage'),
                uploadStatusText: document.getElementById('upload-status-text'),
                uploadFilenameText: document.getElementById('upload-filename-text'),
                pdfViewerModal: document.getElementById('pdf-viewer-modal'),
                pdfViewerIframe: document.getElementById('pdf-viewer-iframe'),
                pdfViewerClose: document.getElementById('pdf-viewer-close'),
            };

            // Create a hidden file input to trigger file selection dialog
            const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = 'application/pdf'; fileInput.multiple = true; fileInput.style.display = 'none'; document.body.appendChild(fileInput);

            // State management variables
            let filesData = []; // Stores objects of {id, file, password}
            let pageRotations = {}; // Stores rotation degrees for each page of each file
            let fileIdCounter = 0; // Ensures each file has a unique ID
            let currentViewerUrl = null; // Holds the blob URL for the PDF viewer to revoke it later

            // --- UI Control Functions ---

            // Switches between the three main screens of the application
            const showScreen = (screen) => {
                elements.initialScreen.style.display = 'none'; elements.fileSelectionScreen.style.display = 'none'; elements.postMergeScreen.style.display = 'none';

                screen.style.display = 'flex';
                const isSelection = screen === elements.fileSelectionScreen;
                [elements.addBtn, elements.settingsBtn, elements.removeAllBtn].forEach(btn => btn.style.display = isSelection ? 'flex' : 'none');
                updateMergeButtonState();
            };

            // Shows a loading spinner with custom text
            const showLoader = (text) => { elements.loadingText.textContent = text; elements.loadingOverlay.style.display = 'flex'; };
            const hideLoader = () => { elements.loadingOverlay.style.display = 'none'; };
            // Displays a temporary message at the top of the screen
            const showMessage = (text) => { elements.messageBox.textContent = text; elements.messageBox.style.display = 'block'; setTimeout(() => { elements.messageBox.style.display = 'none'; }, 4000); };

            // Enables/disables the merge button based on the number of files
            const updateMergeButtonState = () => {
                const disabled = filesData.length < 2;
                elements.mergeBtn.disabled = disabled;
                elements.mergeBtnMobile.disabled = disabled;
                const isMobileView = window.innerWidth <= 768;
                if (isMobileView) {
                    elements.mergeBtnMobile.style.display = filesData.length > 0 ? 'block' : 'none';
                } else {
                    elements.mergeBtnMobile.style.display = 'none';
                }
            };

            // Resets the application to its initial state
            const resetApp = () => {
                filesData = []; pageRotations = {}; fileIdCounter = 0;
                elements.fileList.innerHTML = ''; window.mergedPdfBlob = null;
                showScreen(elements.initialScreen);
                toggleRightPanel(true); // Ensure mobile panel is closed
            };

            // --- File Handling Functions ---

            // Processes a single file: checks for password, creates a file object, and adds it to the list
            const processAndAddFile = async (file) => {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    let pdfDoc;
                    let password = null;

                    try {
                        // First attempt to open without a password
                        pdfDoc = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
                    } catch (e) {
                        if (e.name === 'PasswordException') {
                            // If it's password-protected, prompt the user until they provide the correct one or cancel
                            let correctPasswordFound = false;
                            while (!correctPasswordFound) {
                                const userPassword = prompt(`PDF '${file.name}' is password protected. Please enter the password:`);
                                if (userPassword === null) { // User cancelled the prompt
                                    showMessage(`'${file.name}' was not added because it is password protected.`);
                                    return;
                                }
                                try {
                                    pdfDoc = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer), password: userPassword }).promise;
                                    password = userPassword;
                                    correctPasswordFound = true;
                                } catch (e2) {
                                    if (e2.name === 'InvalidPasswordException') {
                                        alert('Wrong password. Please try again.');
                                    } else {
                                        throw e2; // Some other error occurred
                                    }
                                }
                            }
                        } else {
                            throw e; // A different error occurred (e.g., corrupted file)
                        }
                    }

                    const fileObject = { id: fileIdCounter++, file: file, password: password };
                    filesData.push(fileObject);
                    renderFileBox(fileObject);

                } catch (error) {
                    console.error(`Failed to process ${file.name}:`, error);
                    showMessage(`Could not process '${file.name}'. The file may be invalid or corrupted.`);
                }
            };

            // Takes a list of files, filters them, and processes each valid one
            const addFilesToList = async (files) => {
                const newFiles = Array.from(files).filter(file => {
                    if (file.type !== 'application/pdf') { showMessage(`'${file.name}' is not a PDF.`); return false; }
                    if (filesData.some(f => f.file.name === file.name)) { showMessage(`'${file.name}' is already added.`); return false; }
                    return true;
                });

                if (newFiles.length === 0) {
                    fileInput.value = ''; // Clear input to allow re-selecting the same file if needed
                    return;
                }

                showLoader('Checking files...');
                for (const file of newFiles) {
                    await processAndAddFile(file);
                }
                hideLoader();

                if (filesData.length > 0) {
                    showScreen(elements.fileSelectionScreen);
                }
                updateMergeButtonState();
                fileInput.value = ''; // Clear input
            };

            // Creates the DOM element (card) for a file and renders its preview
            const renderFileBox = (fileObject) => {
                const fileBox = document.createElement('div');
                fileBox.className = 'file-box'; fileBox.dataset.id = fileObject.id;
                fileBox.innerHTML = `
                <canvas></canvas> <p title="${fileObject.file.name}">${fileObject.file.name}</p>
                <button class="rotate-btn action-btn" title="Rotate Document"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></button>
                <button class="view-btn action-btn" title="View Document"><svg viewBox="0 0 24 24" fill="none"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                <button class="remove-btn action-btn" title="Remove Document"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></button>
            `;
                elements.fileList.appendChild(fileBox);
                renderPDFPreview(fileObject, fileBox.querySelector('canvas'));
            };

            // Removes a file from the state and the DOM
            const removeFileById = (idToRemove) => {
                const index = filesData.findIndex(f => f.id === idToRemove);
                if (index > -1) {
                    filesData.splice(index, 1);
                    const fileBox = elements.fileList.querySelector(`.file-box[data-id='${idToRemove}']`);
                    if (fileBox) fileBox.remove();
                    updateMergeButtonState();
                    if (filesData.length === 0) resetApp();
                }
            };

            // Renders the first page of a PDF onto a canvas element
            const renderPDFPreview = async (fileObject, canvas) => {
                const rotationKey = `${fileObject.file.name}-1`; // Only preview first page
                const rotation = pageRotations[rotationKey] || 0;
                try {
                    const arrayBuffer = await fileObject.file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer), password: fileObject.password }).promise;

                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 1.5, rotation });
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                } catch (e) {
                    console.error(`Preview error for ${fileObject.file.name}:`, e);
                    showMessage(`Could not display preview for ${fileObject.file.name}. It might be corrupted.`);
                    const p = canvas.nextElementSibling;
                    if (p) p.style.color = 'red';
                }
            };

            // Updates the filesData array to match the new order in the DOM after drag-and-drop
            const reorderSelectedFiles = () => {
                filesData = Array.from(elements.fileList.children).map(box => {
                    const id = parseInt(box.dataset.id, 10);
                    return filesData.find(f => f.id === id);
                });
            };

            // --- Core Logic ---

            // Simulates an upload progress bar for better user experience
            const simulateUpload = () => {
                return new Promise(resolve => {
                    elements.uploadProgressOverlay.style.display = 'flex';
                    let progress = 0;
                    elements.uploadStatusText.textContent = `Processing ${filesData.length} file(s)...`;
                    elements.uploadFilenameText.textContent = filesData[0].file.name;
                    const interval = setInterval(() => {
                        progress += 1;
                        elements.uploadProgressBar.style.width = `${progress}%`;
                        elements.uploadPercentage.textContent = `${progress}%`;
                        if (progress >= 100) { clearInterval(interval); setTimeout(() => { elements.uploadProgressOverlay.style.display = 'none'; resolve(); }, 500); }
                    }, 35);
                });
            };

            // Merges all selected PDFs into a single new PDF
            const mergePdfs = async () => {
                if (filesData.length < 2) return;
                await simulateUpload(); // Show the simulated progress first
                showLoader('Merging PDFs...');
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay for UX
                try {
                    const { PDFDocument } = window.PDFLib; const mergedPdf = await PDFDocument.create();
                    for (const fileObject of filesData) {
                        const arrayBuffer = await fileObject.file.arrayBuffer();
                        const pdfToMerge = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true, password: fileObject.password });
                        const copiedPages = await mergedPdf.copyPages(pdfToMerge, pdfToMerge.getPageIndices());
                        copiedPages.forEach((page, pageIndex) => {
                            const rotationKey = `${fileObject.file.name}-${pageIndex + 1}`; const rotation = pageRotations[rotationKey] || 0;
                            if (rotation !== 0) page.setRotation(window.PDFLib.degrees(rotation));
                            mergedPdf.addPage(page);
                        });
                    }
                    const mergedPdfBytes = await mergedPdf.save(); window.mergedPdfBlob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                    showScreen(elements.postMergeScreen);
                } catch (error) {
                    console.error(error);
                    showMessage('Merge failed. A file might be corrupted or have an incorrect password.');
                } finally { hideLoader(); }
            };

            // --- Event Listeners Setup ---
            fileInput.addEventListener('change', (e) => addFilesToList(e.target.files));
            elements.selectFilesBtn.addEventListener('click', () => fileInput.click());
            elements.addBtn.addEventListener('click', () => fileInput.click());
            elements.removeAllBtn.addEventListener('click', resetApp);

            // Drag and drop listeners
            elements.dropArea.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); });
            elements.dropArea.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('drag-over'));
            elements.dropArea.addEventListener('drop', (e) => { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); addFilesToList(e.dataTransfer.files); });

            // Event delegation for action buttons on file boxes
            elements.fileList.addEventListener('click', async (e) => {
                const target = e.target.closest('button.action-btn'); if (!target) return;
                const fileBox = target.closest('.file-box'); const fileId = parseInt(fileBox.dataset.id, 10);
                const fileObject = filesData.find(f => f.id === fileId);
                if (!fileObject) return;

                if (target.classList.contains('remove-btn')) {
                    removeFileById(fileId);
                } else if (target.classList.contains('view-btn')) {
                    const isMobile = window.innerWidth <= 768;
                    const fileUrl = URL.createObjectURL(fileObject.file);

                    if (isMobile) {
                        window.open(fileUrl, '_blank'); // Open in new tab on mobile
                    } else {
                        if (currentViewerUrl) URL.revokeObjectURL(currentViewerUrl); // Clean up previous URL
                        currentViewerUrl = fileUrl;
                        elements.pdfViewerIframe.src = currentViewerUrl;
                        elements.pdfViewerModal.style.display = 'flex';
                    }
                } else if (target.classList.contains('rotate-btn')) {
                    showLoader('Rotating...');
                    try {
                        const pdf = await pdfjsLib.getDocument({ data: await fileObject.file.arrayBuffer(), password: fileObject.password }).promise;
                        for (let i = 1; i <= pdf.numPages; i++) { pageRotations[`${fileObject.file.name}-${i}`] = ((pageRotations[`${fileObject.file.name}-${i}`] || 0) + 90) % 360; }
                        await renderPDFPreview(fileObject, fileBox.querySelector('canvas'));
                    } catch (err) {
                        showMessage("Couldn't rotate file.");
                    } finally {
                        hideLoader();
                    }
                }
            });

            // Close the PDF viewer modal
            elements.pdfViewerClose.addEventListener('click', () => {
                elements.pdfViewerModal.style.display = 'none';
                elements.pdfViewerIframe.src = '';
                if (currentViewerUrl) {
                    URL.revokeObjectURL(currentViewerUrl);
                    currentViewerUrl = null;
                }
            });

            // Merge and post-merge screen actions
            [elements.mergeBtn, elements.mergeBtnMobile].forEach(btn => btn.addEventListener('click', mergePdfs));
            elements.downloadBtn.addEventListener('click', () => {
                if (window.mergedPdfBlob) {
                    const url = URL.createObjectURL(window.mergedPdfBlob); const a = document.createElement('a'); a.href = url;
                    a.download = 'Tools-India-Gup-merged.pdf'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                }
            });
            [elements.backArrowBtn, elements.deleteBtn].forEach(btn => btn.addEventListener('click', resetApp));

            // Mobile side panel controls
            const toggleRightPanel = (forceClose = false) => {
                const isOpen = elements.rightPanel.classList.contains('open');
                if (forceClose || isOpen) { elements.rightPanel.classList.remove('open'); elements.rightPanelOverlay.classList.remove('active'); }
                else { elements.rightPanel.classList.add('open'); elements.rightPanelOverlay.classList.add('active'); }
                elements.closeRightPanelBtn.style.display = elements.rightPanel.classList.contains('open') ? 'block' : 'none';
            };
            elements.settingsBtn.addEventListener('click', () => toggleRightPanel());
            elements.closeRightPanelBtn.addEventListener('click', () => toggleRightPanel(true));
            elements.rightPanelOverlay.addEventListener('click', () => toggleRightPanel(true));
            window.addEventListener('resize', updateMergeButtonState);

            // Initialize SortableJS for drag-and-drop reordering
            new Sortable(elements.fileList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                filter: '.action-btn', // Ignore clicks on action buttons for dragging
                preventOnFilter: false,
                onEnd: reorderSelectedFiles // Update data array on reorder
            });

            // Initial setup
            showScreen(elements.initialScreen);
        });
    </script>
</body>

</html>
